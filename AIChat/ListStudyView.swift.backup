import SwiftUI

// MARK: - åˆ—è¡¨å­¦ä¹ æ¨¡å¼è§†å›¾
struct ListStudyView: View {
    @ObservedObject var hybridManager: HybridLearningManager
    @EnvironmentObject var wrongWordManager: WrongWordManager
    @EnvironmentObject var appwriteService: AppwriteService
    @EnvironmentObject var preferencesManager: UserPreferencesManager
    @StateObject private var phoneticService = PhoneticService()
    @StateObject private var studyRecordService: StudyRecordDatabaseService
    @Environment(\.presentationMode) var presentationMode
    
    @State private var currentWords: [StudyWord] = []
    @State private var userAnswers: [String: Bool] = [:] // ç”¨æˆ·ç­”æ¡ˆè®°å½•
    @State private var showingResults = false
    @State private var studyCompleted = false
    @State private var correctCount = 0
    @State private var totalCount = 0
    @State private var isSavingData = false
    
    // å¡ç‰‡æ¨¡å¼ç›¸å…³çŠ¶æ€
    @State private var showingCardMode = false
    
    init(hybridManager: HybridLearningManager) {
        self.hybridManager = hybridManager
        self._studyRecordService = StateObject(wrappedValue: StudyRecordDatabaseService(appwriteService: AppwriteService()))
    }
    
    var body: some View {
        NavigationStack {
            VStack(spacing: 0) {
                // é¡¶éƒ¨è¿›åº¦æ¡å’Œæ¨¡å¼åˆ‡æ¢
                if !studyCompleted {
                    topControlsView
                }
                        VStack(spacing: 8) {
                            // ç¬¬ä¸€è¡Œï¼šæ–‡å­—æ˜¾ç¤ºæ¨¡å¼
                            HStack(spacing: 8) {
                                Text("æ˜¾ç¤ºæ¨¡å¼:")
                                    .font(.caption)
                                    .foregroundStyle(.secondary)
                                
                                HStack(spacing: 4) {
                                    ForEach(ListDisplayMode.allCases, id: \.self) { mode in
                                        Button(action: {
                                            preferencesManager.userPreferences.listDisplayMode = mode
                                        }) {
                                            HStack(spacing: 4) {
                                                Text(mode.emoji)
                                                    .font(.caption)
                                                Text(mode.displayName)
                                                    .font(.caption)
                                                    .fontWeight(.medium)
                                            }
                                            .padding(.horizontal, 8)
                                            .padding(.vertical, 4)
                                            .background(
                                                RoundedRectangle(cornerRadius: 6)
                                                    .fill(preferencesManager.userPreferences.listDisplayMode == mode ? 
                                                          Color.blue.opacity(0.2) : Color.clear)
                                            )
                                            .overlay(
                                                RoundedRectangle(cornerRadius: 6)
                                                    .stroke(preferencesManager.userPreferences.listDisplayMode == mode ? 
                                                            Color.blue : Color.gray.opacity(0.3), lineWidth: 1)
                                            )
                                        }
                                        .buttonStyle(PlainButtonStyle())
                                    }
                                }
                                
                                Spacer()
                            }
                            
                            // ç¬¬äºŒè¡Œï¼šå›¾ç‰‡æ˜¾ç¤ºæ§åˆ¶
                            HStack(spacing: 8) {
                                Text("å›¾ç‰‡æ˜¾ç¤º:")
                                    .font(.caption)
                                    .foregroundStyle(.secondary)
                                
                                Button(action: {
                                    preferencesManager.userPreferences.showImagesInList.toggle()
                                }) {
                                    HStack(spacing: 4) {
                                        Image(systemName: preferencesManager.userPreferences.showImagesInList ? "photo" : "photo.slash")
                                            .font(.caption)
                                        Text(preferencesManager.userPreferences.showImagesInList ? "æ˜¾ç¤ºå›¾ç‰‡" : "éšè—å›¾ç‰‡")
                                            .font(.caption)
                                            .fontWeight(.medium)
                                    }
                                    .padding(.horizontal, 8)
                                    .padding(.vertical, 4)
                                    .background(
                                        RoundedRectangle(cornerRadius: 6)
                                            .fill(preferencesManager.userPreferences.showImagesInList ? 
                                                  Color.green.opacity(0.2) : Color.gray.opacity(0.2))
                                    )
                                    .overlay(
                                        RoundedRectangle(cornerRadius: 6)
                                            .stroke(preferencesManager.userPreferences.showImagesInList ? 
                                                    Color.green : Color.gray, lineWidth: 1)
                                    )
                                }
                                .buttonStyle(PlainButtonStyle())
                                
                                Spacer()
                            }
                        }
                            
                            Spacer()
                            
                            // å¡ç‰‡æµ‹éªŒæŒ‰é’®
                            Button(action: {
                                startCardModeTest()
                            }) {
                                HStack(spacing: 4) {
                                    Image(systemName: "rectangle.stack.fill")
                                        .font(.caption)
                                    Text("å¡ç‰‡æµ‹éªŒ")
                                        .font(.caption)
                                        .fontWeight(.medium)
                                }
                                .padding(.horizontal, 8)
                                .padding(.vertical, 4)
                                .background(
                                    RoundedRectangle(cornerRadius: 6)
                                        .fill(Color.orange.opacity(0.2))
                                )
                                .overlay(
                                    RoundedRectangle(cornerRadius: 6)
                                        .stroke(Color.orange, lineWidth: 1)
                                )
                            }
                            .buttonStyle(PlainButtonStyle())
                            .disabled(currentWords.filter { userAnswers[$0.id.uuidString] == nil }.isEmpty)
                        }
                        
                        ProgressView(value: Double(userAnswers.count), total: Double(currentWords.count))
                            .progressViewStyle(LinearProgressViewStyle(tint: .blue))
                    }
                    .padding(.horizontal, 20)
                    .padding(.vertical, 16)
                    .background(.white)
                }
                
                if studyCompleted {
                    // å®Œæˆç•Œé¢
                    StudyCompletionView(
                        totalWords: totalCount,
                        correctAnswers: correctCount,
                        incorrectAnswers: totalCount - correctCount,
                        onRestart: {
                            restartStudy()
                        },
                        onExit: {
                            presentationMode.wrappedValue.dismiss()
                        }
                    )
                } else if currentWords.isEmpty {
                    // ç©ºçŠ¶æ€ï¼šæ²¡æœ‰å•è¯å¯å­¦ä¹ 
                    VStack(spacing: 20) {
                        Image(systemName: "book.closed")
                            .font(.system(size: 60))
                            .foregroundStyle(.gray)
                        
                        Text("æš‚æ— å­¦ä¹ å†…å®¹")
                            .font(.title2)
                            .fontWeight(.semibold)
                            .foregroundStyle(.primary)
                        
                        Text("è¯·å…ˆå®Œæˆå•è¯è®¾ç½®æˆ–ç­‰å¾…æ•°æ®åŠ è½½")
                            .font(.body)
                            .foregroundStyle(.secondary)
                            .multilineTextAlignment(.center)
                        
                        Button("è¿”å›") {
                            presentationMode.wrappedValue.dismiss()
                        }
                        .buttonStyle(.borderedProminent)
                    }
                    .frame(maxWidth: .infinity, maxHeight: .infinity)
                } else {
                    // æ“ä½œæç¤º
                    VStack(spacing: 8) {
                        HStack {
                            HStack(spacing: 4) {
                                Image(systemName: "arrow.left")
                                    .font(.caption)
                                Text("å·¦æ»‘æ ‡è®°é”™è¯")
                                    .font(.caption)
                            }
                            .foregroundStyle(.orange)
                            
                            Spacer()
                            
                            HStack(spacing: 4) {
                                Text("å³æ»‘æ ‡è®°æŒæ¡")
                                    .font(.caption)
                                Image(systemName: "arrow.right")
                                    .font(.caption)
                            }
                            .foregroundStyle(.green)
                        }
                        
                        Text("ğŸ’¡ ç‚¹å‡»æŸ¥çœ‹ç­”æ¡ˆä¸ä¼šè®°å½•å­¦ä¹ çŠ¶æ€ï¼Œéœ€è¦æ»‘åŠ¨æ¥æ ‡è®°")
                            .font(.caption2)
                            .foregroundStyle(.secondary)
                            .multilineTextAlignment(.center)
                    }
                    .padding(.horizontal, 20)
                    .padding(.vertical, 12)
                    .background(.gray.opacity(0.05))
                    
                    // å­¦ä¹ åˆ—è¡¨
                    ScrollView {
                        LazyVStack(spacing: 16) {
                            ForEach(currentWords) { word in
                                ListStudyWordCard(
                                    word: word,
                                    userAnswer: userAnswers[word.id.uuidString],
                                    onAnswer: { isCorrect in
                                        handleAnswer(for: word.id, isCorrect: isCorrect)
                                    },
                                    phoneticService: phoneticService
                                )
                            }
                        }
                        .padding(.horizontal, 20)
                        .padding(.vertical, 16)
                    }
                }
                
                // åº•éƒ¨æ“ä½œæŒ‰é’®
                if !studyCompleted && userAnswers.count == currentWords.count {
                    VStack(spacing: 12) {
                        Button(action: {
                            showResults()
                        }) {
                            HStack {
                                Image(systemName: "checkmark.circle.fill")
                                Text("æŸ¥çœ‹ç»“æœ")
                            }
                            .font(.headline)
                            .foregroundStyle(.white)
                            .frame(maxWidth: .infinity)
                            .padding(.vertical, 16)
                            .background(.blue)
                            .clipShape(RoundedRectangle(cornerRadius: 12))
                        }
                    }
                    .padding(.horizontal, 20)
                    .padding(.vertical, 16)
                    .background(.white)
                }
            }
            .navigationTitle("åˆ—è¡¨å­¦ä¹ ")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) {
                    Button("é€€å‡º") {
                        saveDataAndExit()
                    }
                    .disabled(isSavingData)
                }
            }
            .onAppear {
                setupStudy()
            }
            .fullScreenCover(isPresented: $showingCardMode) {
            CardModeTestView(
                currentWords: currentWords,
                userAnswers: userAnswers,
                wrongWordManager: wrongWordManager,
                appwriteService: appwriteService,
                preferencesManager: preferencesManager,
                onCardModeCompleted: { updatedAnswers in
                    // æ›´æ–°åˆ—è¡¨æ¨¡å¼çš„å­¦ä¹ è¿›åº¦
                    userAnswers = updatedAnswers
                    showingCardMode = false // å…³é—­å¡ç‰‡æ¨¡å¼
                    
                    // é‡æ–°è®¡ç®—å­¦ä¹ è¿›åº¦
                    updateStudyProgress()
                    
                    print("ğŸ”„ å¡ç‰‡æ¨¡å¼ç­”é¢˜ç»“æœå·²åŒæ­¥åˆ°åˆ—è¡¨æ¨¡å¼")
                    print("- æ€»ç­”é¢˜æ•°: \(userAnswers.count)")
                    print("- æ­£ç¡®æ•°: \(userAnswers.values.filter { $0 }.count)")
                }
            )
        }
    }
    
    // è®¡ç®—å±æ€§ï¼šæ˜¯å¦æœ‰æœªå®Œæˆçš„é¢˜ç›®
    private var hasUnansweredQuestions: Bool {
        userAnswers.count < currentWords.count
    }
    
    private func setupStudy() {
        print("ğŸ“‹ ListStudyView setupStudy å¼€å§‹")
        print("- hybridManager.todayWords.count: \(hybridManager.todayWords.count)")
        print("- hybridManager.allAvailableWords.count: \(hybridManager.allAvailableWords.count)")
        
        currentWords = Array(hybridManager.todayWords.prefix(10)) // é™åˆ¶ä¸º10ä¸ªå•è¯
        totalCount = currentWords.count
        userAnswers.removeAll()
        studyCompleted = false
        correctCount = 0
        
        print("- æœ€ç»ˆ currentWords.count: \(currentWords.count)")
        if currentWords.isEmpty {
            print("âš ï¸ è­¦å‘Šï¼šæ²¡æœ‰å•è¯å¯ä¾›å­¦ä¹ ï¼")
        }
    }
    
    private func handleAnswer(for wordId: UUID, isCorrect: Bool) {
        userAnswers[wordId.uuidString] = isCorrect
        if isCorrect {
            correctCount += 1
        }
    }
    
    private func showResults() {
        showingResults = true
        studyCompleted = true
        
        // è®°å½•å­¦ä¹ ç»“æœåˆ°é”™é¢˜æœ¬ï¼ˆå¦‚æœæœ‰é”™é¢˜ï¼‰
        for word in currentWords {
            if let isCorrect = userAnswers[word.id.uuidString], !isCorrect {
                // åªè®°å½•é”™è¯¯çš„å•è¯åˆ°é”™é¢˜æœ¬
                var wrongWord = WrongWord(
                    word: word.word,
                    meaning: word.meaning,
                    context: word.example,
                    learningDirection: .recognizeMeaning,
                    difficulty: .medium // é»˜è®¤éš¾åº¦
                )
                wrongWord.errorCount = 1
                wrongWord.totalAttempts = 1
                wrongWord.consecutiveWrong = 1
                wrongWordManager.addWrongWord(wrongWord)
            }
        }
    }
    
    private func restartStudy() {
        setupStudy()
    }
    
    // ä¿å­˜æ•°æ®å¹¶é€€å‡º
    private func saveDataAndExit() {
        guard !isSavingData else { return }
        
        isSavingData = true
        print("ğŸ’¾ å¼€å§‹ä¿å­˜å­¦ä¹ æ•°æ®...")
        
        Task {
            await saveStudyRecordsToDatabase()
            
            await MainActor.run {
                isSavingData = false
                presentationMode.wrappedValue.dismiss()
            }
        }
    }
    
    // ä¿å­˜å­¦ä¹ è®°å½•åˆ°æ•°æ®åº“
    private func saveStudyRecordsToDatabase() async {
        print("ğŸ“ ä¿å­˜å­¦ä¹ è®°å½•åˆ°æ•°æ®åº“")
        print("- å·²ç­”é¢˜æ•°é‡: \(userAnswers.count)")
        print("- æ€»é¢˜ç›®æ•°é‡: \(currentWords.count)")
        
        for word in currentWords {
            if let isCorrect = userAnswers[word.id.uuidString] {
                print("ğŸ“ ä¿å­˜å•è¯: \(word.word), æ­£ç¡®: \(isCorrect)")
                
                if isCorrect {
                    // ç­”å¯¹çš„å•è¯ - è®°å½•åˆ°å­¦ä¹ è®°å½•
                    let studyRecord = StudyRecord(
                        userId: appwriteService.currentUser?.id ?? "",
                        word: word.word,
                        meaning: word.meaning,
                        context: word.example,
                        learningDirection: .recognizeMeaning,
                        isCorrect: true,
                        answerTime: 0, // åˆ—è¡¨æ¨¡å¼æ²¡æœ‰è®¡æ—¶
                        memoryStrength: 0.8, // é»˜è®¤è®°å¿†å¼ºåº¦
                        streakCount: 1
                    )
                    
                    // ä¿å­˜å­¦ä¹ è®°å½•åˆ°æ•°æ®åº“
                    studyRecordService.addStudyRecord(studyRecord)
                    print("âœ… ä¿å­˜æ­£ç¡®ç­”é¢˜è®°å½•: \(studyRecord.word)")
                    
                } else {
                    // ç­”é”™çš„å•è¯ - æ·»åŠ åˆ°é”™é¢˜æœ¬
                    let wrongWord = WrongWord(
                        word: word.word,
                        meaning: word.meaning,
                        context: word.example,
                        learningDirection: .recognizeMeaning,
                        difficulty: .medium
                    )
                    
                    await MainActor.run {
                        wrongWordManager.addWrongWord(wrongWord)
                    }
                    
                    print("â­ æ·»åŠ åˆ°é”™é¢˜æœ¬: \(wrongWord.word)")
                }
            } else {
                print("â­ï¸ è·³è¿‡æœªç­”é¢˜: \(word.word)")
            }
        }
        
        print("âœ… å­¦ä¹ è®°å½•ä¿å­˜å®Œæˆ")
    }
    
    // MARK: - å¡ç‰‡æ¨¡å¼æµ‹éªŒ
    private func startCardModeTest() {
        print("ğŸ”„ å¼€å§‹å¡ç‰‡æ¨¡å¼æµ‹éªŒ")
        
        // è·å–æœªå®Œæˆçš„å•è¯
        let remainingWords = currentWords.filter { userAnswers[$0.id.uuidString] == nil }
        print("- æœªå®Œæˆå•è¯æ•°é‡: \(remainingWords.count)")
        
        guard !remainingWords.isEmpty else {
            print("âš ï¸ æ²¡æœ‰æœªå®Œæˆçš„å•è¯ï¼Œæ— æ³•å¼€å§‹å¡ç‰‡æµ‹éªŒ")
            return
        }
        
        // ç›´æ¥æ˜¾ç¤ºå¡ç‰‡æ¨¡å¼
        showingCardMode = true
        
        print("âœ… å¡ç‰‡æ¨¡å¼æµ‹éªŒå·²å¯åŠ¨")
        print("- showingCardMode: \(showingCardMode)")
        print("- currentWords.count: \(currentWords.count)")
        print("- userAnswers.count: \(userAnswers.count)")
    }
    
    // æ›´æ–°å­¦ä¹ è¿›åº¦
    private func updateStudyProgress() {
        correctCount = userAnswers.values.filter { $0 }.count
        studyCompleted = userAnswers.count >= currentWords.count
        
        print("ğŸ“Š å­¦ä¹ è¿›åº¦æ›´æ–°:")
        print("- å·²å®Œæˆ: \(userAnswers.count)/\(currentWords.count)")
        print("- æ­£ç¡®ç‡: \(correctCount)/\(userAnswers.count)")
        print("- å­¦ä¹ å®Œæˆ: \(studyCompleted)")
    }
    
    // é¡¶éƒ¨æ§åˆ¶åŒºåŸŸè§†å›¾
    private var topControlsView: some View {
        VStack(spacing: 12) {
            HStack {
                Text("åˆ—è¡¨å­¦ä¹ æ¨¡å¼")
                    .font(.headline)
                    .fontWeight(.semibold)
                
                Spacer()
                
                Text("\(userAnswers.count)/\(currentWords.count)")
                    .font(.subheadline)
                    .foregroundStyle(.secondary)
            }
            
            // æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢å™¨ - ä¼˜åŒ–æ’ç‰ˆï¼Œåˆ†ä¸¤è¡Œæ˜¾ç¤º
            VStack(spacing: 8) {
                // ç¬¬ä¸€è¡Œï¼šæ–‡å­—æ˜¾ç¤ºæ¨¡å¼
                HStack(spacing: 8) {
                    Text("æ˜¾ç¤ºæ¨¡å¼:")
                        .font(.caption)
                        .foregroundStyle(.secondary)
                    
                    HStack(spacing: 4) {
                        ForEach(ListDisplayMode.allCases, id: \.self) { mode in
                            Button(action: {
                                preferencesManager.userPreferences.listDisplayMode = mode
                            }) {
                                HStack(spacing: 4) {
                                    Text(mode.emoji)
                                        .font(.caption)
                                    Text(mode.displayName)
                                        .font(.caption)
                                        .fontWeight(.medium)
                                }
                                .padding(.horizontal, 8)
                                .padding(.vertical, 4)
                                .background(
                                    RoundedRectangle(cornerRadius: 6)
                                        .fill(preferencesManager.userPreferences.listDisplayMode == mode ? 
                                              Color.blue.opacity(0.2) : Color.clear)
                                )
                                .overlay(
                                    RoundedRectangle(cornerRadius: 6)
                                        .stroke(preferencesManager.userPreferences.listDisplayMode == mode ? 
                                                Color.blue : Color.gray.opacity(0.3), lineWidth: 1)
                                )
                            }
                            .buttonStyle(PlainButtonStyle())
                        }
                    }
                    
                    Spacer()
                }
                
                // ç¬¬äºŒè¡Œï¼šå›¾ç‰‡æ˜¾ç¤ºæ§åˆ¶
                HStack(spacing: 8) {
                    Text("å›¾ç‰‡æ˜¾ç¤º:")
                        .font(.caption)
                        .foregroundStyle(.secondary)
                    
                    Button(action: {
                        preferencesManager.userPreferences.showImagesInList.toggle()
                    }) {
                        HStack(spacing: 4) {
                            Image(systemName: preferencesManager.userPreferences.showImagesInList ? "photo" : "photo.slash")
                                .font(.caption)
                            Text(preferencesManager.userPreferences.showImagesInList ? "æ˜¾ç¤ºå›¾ç‰‡" : "éšè—å›¾ç‰‡")
                                .font(.caption)
                                .fontWeight(.medium)
                        }
                        .padding(.horizontal, 8)
                        .padding(.vertical, 4)
                        .background(
                            RoundedRectangle(cornerRadius: 6)
                                .fill(preferencesManager.userPreferences.showImagesInList ? 
                                      Color.green.opacity(0.2) : Color.gray.opacity(0.2))
                        )
                        .overlay(
                            RoundedRectangle(cornerRadius: 6)
                                .stroke(preferencesManager.userPreferences.showImagesInList ? 
                                        Color.green : Color.gray, lineWidth: 1)
                        )
                    }
                    .buttonStyle(PlainButtonStyle())
                    
                    Spacer()
                }
            }
                
            Spacer()
            
            // å¡ç‰‡æµ‹éªŒæŒ‰é’®
            Button(action: {
                startCardModeTest()
            }) {
                HStack {
                    Image(systemName: "rectangle.stack")
                        .font(.system(size: 16))
                    Text("å¡ç‰‡æµ‹éªŒ")
                        .font(.subheadline)
                        .fontWeight(.medium)
                }
                .foregroundStyle(.white)
                .padding(.horizontal, 20)
                .padding(.vertical, 12)
                .background(.blue)
                .clipShape(RoundedRectangle(cornerRadius: 10))
            }
            .buttonStyle(PlainButtonStyle())
            .disabled(hasUnansweredQuestions)
            .opacity(hasUnansweredQuestions ? 0.6 : 1.0)
            
            // è¿›åº¦æ¡
            ProgressView(value: Double(userAnswers.count), total: Double(currentWords.count))
                .progressViewStyle(LinearProgressViewStyle(tint: .blue))
        }
        .padding(.horizontal, 20)
        .padding(.vertical, 16)
        .background(.white)
    }
}

// MARK: - åˆ—è¡¨å­¦ä¹ å•è¯å¡ç‰‡
struct ListStudyWordCard: View {
    let word: StudyWord
    let userAnswer: Bool?
    let onAnswer: (Bool) -> Void
    @ObservedObject var phoneticService: PhoneticService
    @EnvironmentObject var preferencesManager: UserPreferencesManager
    
    @State private var phonetic: String?
    @State private var showingAnswer = false
    @State private var dragOffset: CGFloat = 0
    
    var body: some View {
        VStack(spacing: 16) {
            // æ ¹æ®æ˜¾ç¤ºæ¨¡å¼æ˜¾ç¤ºå†…å®¹
            switch preferencesManager.userPreferences.listDisplayMode {
            case .hideChinese:
                // é®ä½ä¸­æ–‡æ¨¡å¼ï¼šåªæ˜¾ç¤ºè‹±æ–‡
                englishOnlyView
            case .hideEnglish:
                // é®ä½è‹±æ–‡æ¨¡å¼ï¼šåªæ˜¾ç¤ºä¸­æ–‡
                chineseOnlyView
            case .showAll:
                // éƒ½æ˜¾ç¤ºæ¨¡å¼ï¼šåŒæ—¶æ˜¾ç¤ºè‹±æ–‡å’Œä¸­æ–‡
                bothDisplayView
            }
        }
        .padding(20)
        .background(.white)
        .clipShape(RoundedRectangle(cornerRadius: 16))
        .shadow(color: .black.opacity(0.08), radius: 6, x: 0, y: 3)
        .offset(x: dragOffset)
        .simultaneousGesture(
            DragGesture()
                .onChanged { value in
                    // æ£€æŸ¥æ»‘åŠ¨æ–¹å‘ï¼Œè¦æ±‚æ›´ä¸¥æ ¼çš„æ¡ä»¶
                    let horizontalMovement = abs(value.translation.width)
                    let verticalMovement = abs(value.translation.height)
                    
                    // æ›´ä¸¥æ ¼çš„æ¡ä»¶ï¼šæ°´å¹³æ»‘åŠ¨å¿…é¡»æ˜æ˜¾å¤§äºå‚ç›´æ»‘åŠ¨ï¼Œä¸”è¾¾åˆ°æœ€å°è·ç¦»
                    if horizontalMovement > verticalMovement * 2 && horizontalMovement > 20 {
                        // é™åˆ¶æ»‘åŠ¨èŒƒå›´
                        let maxOffset: CGFloat = 80
                        dragOffset = max(-maxOffset, min(maxOffset, value.translation.width))
                    }
                }
                .onEnded { value in
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„æ°´å¹³æ»‘åŠ¨
                    let horizontalMovement = abs(value.translation.width)
                    let verticalMovement = abs(value.translation.height)
                    
                    // æ›´ä¸¥æ ¼çš„æ¡ä»¶ï¼š
                    // 1. æ°´å¹³æ»‘åŠ¨å¿…é¡»æ˜æ˜¾å¤§äºå‚ç›´æ»‘åŠ¨ï¼ˆè‡³å°‘2å€ï¼‰
                    // 2. æ°´å¹³æ»‘åŠ¨è·ç¦»å¿…é¡»è¶³å¤Ÿå¤§ï¼ˆè‡³å°‘80pxï¼‰
                    // 3. æ»‘åŠ¨é€Ÿåº¦ä¸èƒ½å¤ªå¿«ï¼ˆé¿å…è¯¯è§¦ï¼‰
                    let isValidHorizontalSwipe = horizontalMovement > verticalMovement * 2 && 
                                               horizontalMovement > 80 &&
                                               abs(value.velocity.width) < 1000
                    
                    if isValidHorizontalSwipe {
                        let threshold: CGFloat = 80
                        
                        withAnimation(.spring(response: 0.4, dampingFraction: 0.8)) {
                            if value.translation.width > threshold {
                                // å³æ»‘ - æ ‡è®°ä¸ºæŒæ¡
                                print("âœ… å³æ»‘æ ‡è®°æŒæ¡: \(word.word)")
                                onAnswer(true)
                                dragOffset = 0
                            } else if value.translation.width < -threshold {
                                // å·¦æ»‘ - æ ‡è®°ä¸ºé”™è¯
                                print("â­ å·¦æ»‘æ ‡è®°é”™è¯: \(word.word)")
                                onAnswer(false)
                                dragOffset = 0
                            } else {
                                dragOffset = 0
                            }
                        }
                    } else {
                        // ä¸ç¬¦åˆæ¡ä»¶ï¼Œé‡ç½®åç§»
                        withAnimation(.spring(response: 0.4, dampingFraction: 0.8)) {
                            dragOffset = 0
                        }
                    }
                }
        )
        .onTapGesture {
            // ç‚¹å‡»æ•´ä¸ªå¡ç‰‡æ—¶æ’­æ”¾å‘éŸ³
            print("ğŸµ ç”¨æˆ·ç‚¹å‡»å¡ç‰‡æ’­æ”¾å‘éŸ³: \(word.word)")
            phoneticService.playPronunciation(for: word.word, pronunciationType: preferencesManager.userPreferences.pronunciationType) {}
        }
        .onAppear {
            loadPhonetic()
        }
    }
    
    private func loadPhonetic() {
        phonetic = phoneticService.getPhoneticSymbol(for: word.word, pronunciationType: preferencesManager.userPreferences.pronunciationType)
    }
    
    // MARK: - é®ä½ä¸­æ–‡æ¨¡å¼ï¼šåªæ˜¾ç¤ºè‹±æ–‡
    private var englishOnlyView: some View {
        VStack(spacing: 16) {
            // è‹±æ–‡å•è¯ä¿¡æ¯ï¼ˆç‚¹å‡»æ•´ä¸ªåŒºåŸŸå‘éŸ³ï¼‰
            Button(action: {
                phoneticService.playPronunciation(for: word.word, pronunciationType: preferencesManager.userPreferences.pronunciationType) {}
            }) {
                HStack {
                    VStack(alignment: .leading, spacing: 4) {
                        Text(word.word)
                            .font(.title2)
                            .fontWeight(.bold)
                            .foregroundStyle(.primary)
                        
                        ClickablePhoneticView(word: word.word, phoneticService: phoneticService)
                    }
                    
                    Spacer()
                    
                    // å›¾ç‰‡å’Œå‘éŸ³æŒ‰é’®
                    HStack(spacing: 8) {
                        // å•è¯å›¾ç‰‡ï¼ˆæ ¹æ®è®¾ç½®æ˜¾ç¤ºæˆ–éšè—ï¼‰
                        if preferencesManager.userPreferences.showImagesInList {
                            WordImageView(imageURL: word.imageURL, word: word.word)
                        }
                        
                        // è®°å¿†è¾…åŠ©ä¿¡æ¯
                        MemoryAidView(
                            etymology: word.etymology,
                            memoryTip: word.memoryTip,
                            relatedWords: word.relatedWords
                        )
                        
                        // å‘éŸ³æŒ‰é’®å›¾æ ‡
                        Image(systemName: "speaker.wave.2.fill")
                            .font(.system(size: 16))
                            .foregroundStyle(.blue)
                            .padding(8)
                            .background(.blue.opacity(0.1))
                            .clipShape(Circle())
                    }
                }
            }
            .buttonStyle(PlainButtonStyle())
            
            // å›ºå®šé«˜åº¦çš„ä¸­æ–‡æ„æ€æ˜¾ç¤ºåŒºåŸŸ
            HStack {
                if showingAnswer || userAnswer != nil {
                    // æ˜¾ç¤ºä¸­æ–‡æ„æ€
                    Text(word.meaning)
                        .font(.subheadline)
                        .foregroundStyle(.secondary)
                        .multilineTextAlignment(.leading)
                } else {
                    // æç¤ºç‚¹å‡»æ˜¾ç¤ºç­”æ¡ˆ
                    Button(action: {
                        print("ğŸ“– ç”¨æˆ·ç‚¹å‡»æ˜¾ç¤ºç­”æ¡ˆ: \(word.word)")
                        // æ’­æ”¾å‘éŸ³
                        phoneticService.playPronunciation(for: word.word, pronunciationType: preferencesManager.userPreferences.pronunciationType) {}
                        // æ˜¾ç¤ºç­”æ¡ˆ
                        withAnimation(.easeInOut(duration: 0.3)) {
                            showingAnswer = true
                        }
                    }) {
                        HStack {
                            Image(systemName: "eye")
                                .font(.caption)
                            Text("ç‚¹å‡»æŸ¥çœ‹ä¸­æ–‡å«ä¹‰")
                                .font(.caption)
                        }
                        .foregroundStyle(.blue)
                    }
                    .buttonStyle(PlainButtonStyle())
                }
                
                Spacer()
                
                // ç­”æ¡ˆçŠ¶æ€æ˜¾ç¤º
                answerStatusView
            }
            .frame(height: 32) // å›ºå®šé«˜åº¦
            .padding(.horizontal, 12)
            .background(.gray.opacity(0.1))
            .clipShape(RoundedRectangle(cornerRadius: 8))
        }
    }
    
    // MARK: - é®ä½è‹±æ–‡æ¨¡å¼ï¼šåªæ˜¾ç¤ºä¸­æ–‡
    private var chineseOnlyView: some View {
        VStack(spacing: 16) {
            // ä¸­æ–‡æ„æ€ä¿¡æ¯
            HStack {
                VStack(alignment: .leading, spacing: 4) {
                    if showingAnswer || userAnswer != nil {
                        // æ˜¾ç¤ºè‹±æ–‡å•è¯ï¼ˆç‚¹å‡»æ•´ä¸ªåŒºåŸŸå‘éŸ³ï¼‰
                        Button(action: {
                            phoneticService.playPronunciation(for: word.word, pronunciationType: preferencesManager.userPreferences.pronunciationType) {}
                        }) {
                            HStack {
                                VStack(alignment: .leading, spacing: 4) {
                                    Text(word.word)
                                        .font(.title2)
                                        .fontWeight(.bold)
                                        .foregroundStyle(.primary)
                                    
                                    ClickablePhoneticView(word: word.word, phoneticService: phoneticService)
                                }
                                
                                Spacer()
                                
                                // å›¾ç‰‡å’Œå‘éŸ³æŒ‰é’®
                                HStack(spacing: 8) {
                                    // å•è¯å›¾ç‰‡
                                    WordImageView(imageURL: word.imageURL, word: word.word)
                                    
                                    // è®°å¿†è¾…åŠ©ä¿¡æ¯
                                    MemoryAidView(
                                        etymology: word.etymology,
                                        memoryTip: word.memoryTip,
                                        relatedWords: word.relatedWords
                                    )
                                    
                                    // å‘éŸ³æŒ‰é’®å›¾æ ‡
                                    Image(systemName: "speaker.wave.2.fill")
                                        .font(.system(size: 16))
                                        .foregroundStyle(.blue)
                                        .padding(8)
                                        .background(.blue.opacity(0.1))
                                        .clipShape(Circle())
                                }
                            }
                        }
                        .buttonStyle(PlainButtonStyle())
                    } else {
                        // æç¤ºç‚¹å‡»æ˜¾ç¤ºè‹±æ–‡
                        Button(action: {
                            print("ğŸ“– ç”¨æˆ·ç‚¹å‡»æ˜¾ç¤ºè‹±æ–‡: \(word.meaning)")
                            withAnimation(.easeInOut(duration: 0.3)) {
                                showingAnswer = true
                            }
                        }) {
                            HStack {
                                Image(systemName: "eye")
                                    .font(.caption)
                                Text("ç‚¹å‡»æŸ¥çœ‹è‹±æ–‡å•è¯")
                                    .font(.caption)
                            }
                            .foregroundStyle(.blue)
                        }
                        .buttonStyle(PlainButtonStyle())
                    }
                }
                
                Spacer()
            }
            
            // å›ºå®šé«˜åº¦çš„ä¸­æ–‡æ„æ€æ˜¾ç¤ºåŒºåŸŸ
            HStack {
                // å§‹ç»ˆæ˜¾ç¤ºä¸­æ–‡æ„æ€
                Text(word.meaning)
                    .font(.subheadline)
                    .foregroundStyle(.secondary)
                    .multilineTextAlignment(.leading)
                
                Spacer()
                
                // ç­”æ¡ˆçŠ¶æ€æ˜¾ç¤º
                answerStatusView
            }
            .frame(height: 32) // å›ºå®šé«˜åº¦
            .padding(.horizontal, 12)
            .background(.gray.opacity(0.1))
            .clipShape(RoundedRectangle(cornerRadius: 8))
        }
    }
    
    // MARK: - éƒ½æ˜¾ç¤ºæ¨¡å¼ï¼šåŒæ—¶æ˜¾ç¤ºè‹±æ–‡å’Œä¸­æ–‡
    private var bothDisplayView: some View {
        VStack(spacing: 16) {
            // è‹±æ–‡å•è¯ä¿¡æ¯ï¼ˆç‚¹å‡»æ•´ä¸ªåŒºåŸŸå‘éŸ³ï¼‰
            Button(action: {
                phoneticService.playPronunciation(for: word.word, pronunciationType: preferencesManager.userPreferences.pronunciationType) {}
            }) {
                HStack {
                    VStack(alignment: .leading, spacing: 4) {
                        Text(word.word)
                            .font(.title2)
                            .fontWeight(.bold)
                            .foregroundStyle(.primary)
                        
                        ClickablePhoneticView(word: word.word, phoneticService: phoneticService)
                    }
                    
                    Spacer()
                    
                    // å›¾ç‰‡å’Œå‘éŸ³æŒ‰é’®
                    HStack(spacing: 8) {
                        // å•è¯å›¾ç‰‡ï¼ˆæ ¹æ®è®¾ç½®æ˜¾ç¤ºæˆ–éšè—ï¼‰
                        if preferencesManager.userPreferences.showImagesInList {
                            WordImageView(imageURL: word.imageURL, word: word.word)
                        }
                        
                        // è®°å¿†è¾…åŠ©ä¿¡æ¯
                        MemoryAidView(
                            etymology: word.etymology,
                            memoryTip: word.memoryTip,
                            relatedWords: word.relatedWords
                        )
                        
                        // å‘éŸ³æŒ‰é’®å›¾æ ‡
                        Image(systemName: "speaker.wave.2.fill")
                            .font(.system(size: 16))
                            .foregroundStyle(.blue)
                            .padding(8)
                            .background(.blue.opacity(0.1))
                            .clipShape(Circle())
                    }
                }
            }
            .buttonStyle(PlainButtonStyle())
            
            // å›ºå®šé«˜åº¦çš„ä¸­æ–‡æ„æ€æ˜¾ç¤ºåŒºåŸŸ
            HStack {
                // å§‹ç»ˆæ˜¾ç¤ºä¸­æ–‡æ„æ€
                Text(word.meaning)
                    .font(.subheadline)
                    .foregroundStyle(.secondary)
                    .multilineTextAlignment(.leading)
                
                Spacer()
                
                // ç­”æ¡ˆçŠ¶æ€æ˜¾ç¤º
                answerStatusView
            }
            .frame(height: 32) // å›ºå®šé«˜åº¦
            .padding(.horizontal, 12)
            .background(.gray.opacity(0.1))
            .clipShape(RoundedRectangle(cornerRadius: 8))
        }
    }
    
    // MARK: - ç­”æ¡ˆçŠ¶æ€æ˜¾ç¤ºè§†å›¾
    private var answerStatusView: some View {
        Group {
            if let answer = userAnswer {
                if answer {
                    HStack(spacing: 4) {
                        Image(systemName: "checkmark.circle.fill")
                            .foregroundStyle(.green)
                            .font(.caption)
                        Text("å·²æŒæ¡")
                            .font(.caption)
                            .fontWeight(.medium)
                            .foregroundStyle(.green)
                    }
                } else {
                    HStack(spacing: 4) {
                        Image(systemName: "star.fill")
                            .foregroundStyle(.orange)
                            .font(.caption)
                        Text("å¾…å¤ä¹ ")
                            .font(.caption)
                            .fontWeight(.medium)
                            .foregroundStyle(.orange)
                    }
                }
            }
        }
    }
}


// MARK: - å­¦ä¹ å®Œæˆè§†å›¾
struct StudyCompletionView: View {
    let totalWords: Int
    let correctAnswers: Int
    let incorrectAnswers: Int
    let onRestart: () -> Void
    let onExit: () -> Void
    
    var accuracy: Double {
        guard totalWords > 0 else { return 0 }
        return Double(correctAnswers) / Double(totalWords)
    }
    
    var body: some View {
        VStack(spacing: 24) {
            // å®Œæˆå›¾æ ‡
            Image(systemName: "checkmark.circle.fill")
                .font(.system(size: 80))
                .foregroundStyle(.green)
            
            // æ ‡é¢˜
            Text("å­¦ä¹ å®Œæˆï¼")
                .font(.largeTitle)
                .fontWeight(.bold)
                .foregroundStyle(.primary)
            
            // ç»Ÿè®¡ä¿¡æ¯
            VStack(spacing: 16) {
                HStack(spacing: 20) {
                    // æ€»é¢˜æ•°
                    VStack(spacing: 4) {
                        Text("\(totalWords)")
                            .font(.title2)
                            .fontWeight(.bold)
                            .foregroundStyle(.blue)
                        
                        Text("æ€»é¢˜æ•°")
                            .font(.caption)
                            .foregroundStyle(.secondary)
                    }
                    .frame(maxWidth: .infinity)
                    .padding()
                    .background(Color.blue.opacity(0.1))
                    .clipShape(RoundedRectangle(cornerRadius: 8))
                    
                    // æ­£ç¡®
                    VStack(spacing: 4) {
                        Text("\(correctAnswers)")
                            .font(.title2)
                            .fontWeight(.bold)
                            .foregroundStyle(.green)
                        
                        Text("æ­£ç¡®")
                            .font(.caption)
                            .foregroundStyle(.secondary)
                    }
                    .frame(maxWidth: .infinity)
                    .padding()
                    .background(Color.green.opacity(0.1))
                    .clipShape(RoundedRectangle(cornerRadius: 8))
                    
                    // é”™è¯¯
                    VStack(spacing: 4) {
                        Text("\(incorrectAnswers)")
                            .font(.title2)
                            .fontWeight(.bold)
                            .foregroundStyle(.red)
                        
                        Text("é”™è¯¯")
                            .font(.caption)
                            .foregroundStyle(.secondary)
                    }
                    .frame(maxWidth: .infinity)
                    .padding()
                    .background(Color.red.opacity(0.1))
                    .clipShape(RoundedRectangle(cornerRadius: 8))
                }
                
                // å‡†ç¡®ç‡
                VStack(spacing: 8) {
                    Text("å‡†ç¡®ç‡")
                        .font(.headline)
                        .foregroundStyle(.secondary)
                    
                    Text("\(Int(accuracy * 100))%")
                        .font(.title)
                        .fontWeight(.bold)
                        .foregroundStyle(accuracy >= 0.8 ? .green : accuracy >= 0.6 ? .orange : .red)
                }
                .padding()
                .background(.quaternary.opacity(0.3))
                .clipShape(RoundedRectangle(cornerRadius: 12))
            }
            
            // æ“ä½œæŒ‰é’®
            VStack(spacing: 12) {
                Button(action: onRestart) {
                    HStack {
                        Image(systemName: "arrow.clockwise")
                        Text("é‡æ–°å­¦ä¹ ")
                    }
                    .font(.headline)
                    .foregroundStyle(.white)
                    .frame(maxWidth: .infinity)
                    .padding(.vertical, 16)
                    .background(.blue)
                    .clipShape(RoundedRectangle(cornerRadius: 12))
                }
                
                Button(action: onExit) {
                    HStack {
                        Image(systemName: "house.fill")
                        Text("è¿”å›ä¸»é¡µ")
                    }
                    .font(.headline)
                    .foregroundStyle(.blue)
                    .frame(maxWidth: .infinity)
                    .padding(.vertical, 16)
                    .background(.blue.opacity(0.1))
                    .clipShape(RoundedRectangle(cornerRadius: 12))
                }
            }
        }
        .padding(.horizontal, 32)
        .frame(maxWidth: .infinity, maxHeight: .infinity)
    }
}


// MARK: - å¡ç‰‡æ¨¡å¼åŒ…è£…å™¨
struct CardModeWrapper: View {
    @ObservedObject var hybridManager: HybridLearningManager
    let currentWords: [StudyWord]
    let wrongWordManager: WrongWordManager
    let onAnswerRecorded: (String, Bool) -> Void
    let onCompleted: () -> Void
    
    @State private var lastProgress: Double = 0.0
    @State private var recordedWords: Set<String> = []
    
    var body: some View {
        HybridLearningView(hybridManager: hybridManager)
            .onReceive(hybridManager.$learningProgress) { progress in
                // ç›‘å¬å­¦ä¹ è¿›åº¦çš„å˜åŒ–
                if progress > lastProgress {
                    // å­¦ä¹ è¿›åº¦å¢åŠ äº†ï¼Œè¯´æ˜æœ‰æ–°çš„å•è¯è¢«å®Œæˆ
                    let completedCount = Int(progress * Double(currentWords.count))
                    let previousCompletedCount = Int(lastProgress * Double(currentWords.count))
                    
                    // è®°å½•æ–°å®Œæˆçš„å•è¯
                    if completedCount > previousCompletedCount {
                        for i in previousCompletedCount..<completedCount {
                            if i < currentWords.count {
                                let wordId = currentWords[i].id.uuidString
                                if !recordedWords.contains(wordId) {
                                    // è®°å½•è¿™ä¸ªå•è¯çš„ç­”é¢˜ç»“æœ
                                    // æš‚æ—¶å‡è®¾åœ¨å¡ç‰‡æ¨¡å¼ä¸­ç­”å¯¹äº†ï¼ˆå› ä¸ºç”¨æˆ·å®Œæˆäº†å­¦ä¹ ï¼‰
                                    onAnswerRecorded(wordId, true)
                                    recordedWords.insert(wordId)
                                }
                            }
                        }
                    }
                    
                    lastProgress = progress
                }
                
                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å•è¯éƒ½å®Œæˆäº†
                if progress >= 1.0 {
                    DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
                        onCompleted()
                    }
                }
            }
    }
}

// MARK: - å¡ç‰‡æ¨¡å¼æµ‹è¯•è§†å›¾
struct CardModeTestView: View {
    let currentWords: [StudyWord]
    let userAnswers: [String: Bool]
    let wrongWordManager: WrongWordManager
    let appwriteService: AppwriteService
    let preferencesManager: UserPreferencesManager
    let onCardModeCompleted: ([String: Bool]) -> Void // å¡ç‰‡æ¨¡å¼å®Œæˆæ—¶çš„å›è°ƒ
    
    @State private var cardManager: HybridLearningManager?
    @State private var cardModeAnswers: [String: Bool] = [:] // å¡ç‰‡æ¨¡å¼ä¸­çš„ç­”é¢˜è®°å½•
    
    // è®¡ç®—æœªå®Œæˆçš„å•è¯
    private var remainingWords: [StudyWord] {
        currentWords.filter { userAnswers[$0.id.uuidString] == nil }
    }
    
    var body: some View {
        let _ = print("ğŸ”„ CardModeTestView è¢«è°ƒç”¨")
        let _ = print("- currentWords.count: \(currentWords.count)")
        let _ = print("- userAnswers.count: \(userAnswers.count)")
        let _ = print("- remainingWords.count: \(remainingWords.count)")
        
        if !remainingWords.isEmpty {
            let _ = print("âœ… åˆ›å»º HybridLearningView")
            
            if let manager = cardManager {
                CardModeWrapper(
                    hybridManager: manager,
                    currentWords: remainingWords,
                    wrongWordManager: wrongWordManager,
                    onAnswerRecorded: { wordId, isCorrect in
                        // è®°å½•å¡ç‰‡æ¨¡å¼ä¸­çš„ç­”é¢˜ç»“æœ
                        cardModeAnswers[wordId] = isCorrect
                        print("ğŸ¯ å¡ç‰‡æ¨¡å¼ç­”é¢˜è®°å½•: \(wordId) -> \(isCorrect)")
                        
                        // å¦‚æœç­”å¯¹äº†ï¼Œå°†å•è¯æ ‡è®°ä¸ºå·²æŒæ¡
                        if isCorrect {
                            if let word = remainingWords.first(where: { $0.id.uuidString == wordId }) {
                                // åˆ›å»ºWrongWordå¯¹è±¡å¹¶æ ‡è®°ä¸ºå·²æŒæ¡
                                let wrongWord = WrongWord(
                                    word: word.word,
                                    meaning: word.meaning,
                                    context: word.example,
                                    learningDirection: .recognizeMeaning
                                )
                                wrongWordManager.markAsMastered(wrongWord)
                                print("âœ… å•è¯å·²æ ‡è®°ä¸ºå·²æŒæ¡: \(word.word)")
                            }
                        }
                    },
                    onCompleted: {
                        // å¡ç‰‡æ¨¡å¼å®Œæˆæ—¶ï¼Œåˆå¹¶ç­”é¢˜ç»“æœå¹¶å›è°ƒ
                        var mergedAnswers = userAnswers
                        for (wordId, isCorrect) in cardModeAnswers {
                            mergedAnswers[wordId] = isCorrect
                        }
                        onCardModeCompleted(mergedAnswers)
                        print("âœ… å¡ç‰‡æ¨¡å¼å®Œæˆï¼Œåˆå¹¶ç­”é¢˜ç»“æœ: \(mergedAnswers.count) ä¸ªç­”æ¡ˆ")
                    }
                )
                .environmentObject(wrongWordManager)
                .environmentObject(appwriteService)
                .environmentObject(preferencesManager)
                .environmentObject(ThemeManager.shared)
            } else {
                ProgressView("æ­£åœ¨åˆå§‹åŒ–å¡ç‰‡æ¨¡å¼...")
                    .onAppear {
                        cardManager = HybridLearningManager(appwriteService: AppwriteService())
                        cardManager?.loadWordsFromList(remainingWords)
                    }
            }
        } else {
            let _ = print("âš ï¸ remainingWords ä¸ºç©º")
            Text("æ²¡æœ‰å¯æµ‹éªŒçš„å•è¯")
                .foregroundStyle(.red)
        }
    }
}

// MARK: - Preview
#Preview {
    ListStudyView(hybridManager: HybridLearningManager(appwriteService: AppwriteService()))
        .environmentObject(WrongWordManager())
}
